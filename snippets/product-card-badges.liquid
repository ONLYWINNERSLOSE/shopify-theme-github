<div
  class="product-badges product-badges--{{ settings.badge_position }}"
  style="
    --badge-border-radius: {{ settings.badge_corner_radius }}px;

    --badge-font-family: 'Reenie Beanie', cursive;
    --badge-font-weight: 400;
    --badge-text-transform: none;

    /* UNE SEULE TAILLE POUR TOUS */
    --badge-font-size: {{ settings.badge_font_size }}px;
    --badge-font-size-mobile: {{ settings.badge_font_size_mobile }}px;

    --badge-letter-spacing: -0.075em;
    --badge-scale-x: 2.25095;

    --badge-gap-mobile: {{ settings.badge_gap_mobile }}px;
  "
>
  {%- assign main_badge = '' -%}
  {%- assign state_badge = '' -%}

  {%- comment -%} Badge principal (en haut) {%- endcomment -%}
  {%- if product.tags contains 'soon' -%}
    {%- capture main_badge -%}
      <div class="product-badges__badge badge-pill product-badges__badge--rectangle">
        <span class="badge-text">Soon</span>
      </div>
    {%- endcapture -%}
  {%- elsif product.tags contains 'archive' -%}
    {%- capture main_badge -%}
      <div class="product-badges__badge badge-pill product-badges__badge--rectangle">
        <span class="badge-text">Archivé</span>
      </div>
    {%- endcapture -%}
  {%- elsif product.tags contains 'owl_studio' -%}
    {%- capture main_badge -%}
      <div class="product-badges__badge badge-pill product-badges__badge--rectangle">
        <span class="badge-text">Studio</span>
      </div>
    {%- endcapture -%}
  {%- elsif product.tags contains 'owl_made' -%}
    {%- capture main_badge -%}
      <div class="product-badges__badge badge-pill product-badges__badge--rectangle">
        <span class="badge-text">Made</span>
      </div>
    {%- endcapture -%}
  {%- elsif product.tags contains 'owl_creative' -%}
    {%- capture main_badge -%}
      <div class="product-badges__badge badge-pill product-badges__badge--rectangle">
        <span class="badge-text">Creative</span>
      </div>
    {%- endcapture -%}
  {%- elsif product.tags contains 'preorder' -%}
    {%- capture main_badge -%}
      <div class="product-badges__badge badge-pill product-badges__badge--rectangle">
        <span class="badge-text">Précommande</span>
      </div>
    {%- endcapture -%}
  {%- endif -%}

  {%- comment -%} Badge état produit (en dessous) {%- endcomment -%}
  {%- if product.available == false -%}
    {%- capture state_badge -%}
      <div class="product-badges__badge badge-pill product-badges__badge--rectangle color-{{ settings.badge_sold_out_color_scheme }}">
        <span class="badge-text">{{ 'content.product_badge_sold_out' | t }}</span>
      </div>
    {%- endcapture -%}
  {%- elsif product.compare_at_price > product.price -%}
    {%- capture state_badge -%}
      <div class="product-badges__badge badge-pill product-badges__badge--rectangle color-{{ settings.badge_sale_color_scheme }}">
        <span class="badge-text">{{ 'content.product_badge_sale' | t }}</span>
      </div>
    {%- endcapture -%}
  {%- elsif product.tags contains 'new' -%}
    {%- capture state_badge -%}
      <div class="product-badges__badge badge-pill product-badges__badge--rectangle">
        <span class="badge-text">New</span>
      </div>
    {%- endcapture -%}
  {%- endif -%}

  {{ main_badge }}
  {{ state_badge }}
</div>

{% stylesheet %}
/* ===== Container ===== */
.product-badges {
  --badge-inset: max(var(--padding-xs), calc((var(--border-radius) + var(--padding-xs)) * (1 - cos(45deg))));
  position: absolute;
  z-index: var(--layer-flat);

  display: inline-flex;
  flex-direction: column;
  gap: 6px;

  width: max-content;
  align-items: stretch;
}

/* positions */
.product-badges--bottom-left {
  bottom: calc(var(--badge-inset) + var(--padding-block-start));
  left: calc(var(--badge-inset) + var(--padding-inline-start));
}
.product-badges--top-left {
  top: calc(var(--badge-inset) + var(--padding-block-start));
  left: calc(var(--badge-inset) + var(--padding-inline-start));
}
.product-badges--top-right {
  top: calc(var(--badge-inset) + var(--padding-block-start));
  right: calc(var(--badge-inset) + var(--padding-inline-start));
}

/* ===== Badge ===== */
.product-badges__badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-align: center;

  color: var(--color-foreground);
  background: var(--color-background);

  border-radius: var(--badge-border-radius);
  white-space: nowrap;

  overflow: hidden;

  /* PARAMS IDENTIQUES POUR TOUS */
  font-family: var(--badge-font-family);
  font-weight: var(--badge-font-weight);
  text-transform: var(--badge-text-transform);
  font-size: var(--badge-font-size);
}

/* Padding identique HAUT + BAS */
.product-badges__badge--rectangle {
  padding-block: var(--badge-rectangle-padding-block);
  padding-inline: var(--badge-rectangle-padding-inline);
}

/* largeur commune */
.product-badges .badge-pill {
  width: 100%;
}

/* Mobile */
@media screen and (max-width: 749px) {
  .product-badges {
    gap: var(--badge-gap-mobile);
  }

  .product-badges__badge {
    font-size: var(--badge-font-size-mobile);
  }
}

/* ===== Texte (fit + scaleX) ===== */
.product-badges__badge .badge-text {
  display: inline-block;
  font-family: inherit;
  font-weight: inherit;
  text-transform: none;
  white-space: nowrap;

  letter-spacing: var(--badge-letter-spacing);
  transform-origin: center;

  transform: scaleX(calc(var(--badge-scale-x) * var(--badge-fit-x, 1)));
}
{% endstylesheet %}

<script>
(function () {
  function fitOne(badge) {
    const text = badge.querySelector('.badge-text');
    if (!text) return;

    text.style.setProperty('--badge-fit-x', 1);

    const s = getComputedStyle(badge);
    const pl = parseFloat(s.paddingLeft) || 0;
    const pr = parseFloat(s.paddingRight) || 0;
    const available = badge.clientWidth - pl - pr;
    if (available <= 0) return;

    const used = text.getBoundingClientRect().width;
    if (used <= 0) return;

    const fitX = Math.min(1, available / used);
    text.style.setProperty('--badge-fit-x', fitX.toFixed(4));
  }

  function fitAll(root) {
    (root || document).querySelectorAll('.product-badges__badge').forEach(fitOne);
  }

  const run = () => requestAnimationFrame(() => fitAll());

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run);
  } else {
    run();
  }

  window.addEventListener('resize', run);

  const obs = new MutationObserver(() => run());
  obs.observe(document.documentElement, { childList: true, subtree: true });
})();
</script>
