{% liquid
  assign widths = '300, 450, 600, 750, 900, 1050, 1200, 1350, 1500, 1650, 1800, 1950, 2100, 2400, 2700, 3000, 3300, 3600'
  assign is_full_width = block.settings.full_width

  if is_full_width
    assign desktop_size = '(min-width: 750px) calc((100vw - 2px) / 3)'
    assign mobile_size = 'calc((100vw - 2px) / 3)'
  else
    assign desktop_size = '(min-width: 750px) calc((min(100vw, var(--page-width)) - 2px) / 3)'
    assign mobile_size = 'calc((min(100vw, var(--page-width)) - 2px) / 3)'
  endif
  assign sizes = mobile_size | append: ', ' | append: desktop_size

  assign aspect_ratio = null

  case block.settings.image_ratio
    when 'square'
      assign aspect_ratio = '1 / 1'
    when 'landscape'
      assign aspect_ratio = '4 / 3'
    when 'portrait'
      assign aspect_ratio = '3 / 4'
    when 'widescreen'
      assign aspect_ratio = '16 / 9'
  endcase

  if block.settings.image_ratio == 'adapt'
    assign aspect_ratio = null
  endif

  if aspect_ratio
    assign container_class = 'three-image-row three-image-row--has-ratio'
  else
    assign container_class = 'three-image-row'
  endif

  if is_full_width
    assign container_class = container_class | append: ' three-image-row--full-width'
  endif

  if block.settings.height == 'custom'
    assign container_class = container_class | append: ' three-image-row--fixed-height'
  endif

  capture container_style
    if aspect_ratio
      echo '--three-image-row-aspect: ' | append: aspect_ratio | append: ';'
    endif
    if block.settings.height == 'custom'
      echo '--three-image-row-height: ' | append: block.settings.custom_height | append: 'px;'
    endif
  endcapture
%}

<div class="{{ container_class }}"{% if container_style != blank %} style="{{ container_style | strip }}"{% endif %} {{ block.shopify_attributes }}>
  {% for i in (1..3) %}
    {% assign image_setting = 'image_' | append: i %}
    {% assign link_setting = 'link_' | append: i %}
    {% assign alt_setting = 'image_' | append: i | append: '_alt' %}
    {% assign text_setting = 'text_' | append: i %}
    {% assign text_position_setting = 'text_position_' | append: i %}

    {% assign image = block.settings[image_setting] %}
    {% assign link = block.settings[link_setting] %}
    {% assign alt_text = block.settings[alt_setting] %}
    {% assign overlay_text = block.settings[text_setting] %}
    {% assign text_position = block.settings[text_position_setting] | default: 'center' %}

    {% liquid
      if alt_text == blank and image != blank and image.alt != blank
        assign alt_text = image.alt
      endif

      if alt_text == blank
        assign alt_text = 'Image ' | append: i
      endif
    %}

    <div class="three-image-row__item">
      {% if image %}
        {% capture media_content %}
          {{
            image
            | image_url: width: 3840
            | image_tag:
              widths: widths,
              sizes: sizes,
              loading: 'lazy',
              class: 'three-image-row__image',
              alt: alt_text
          }}
          {% if overlay_text != blank %}
            <span class="three-image-row__text three-image-row__text--{{ text_position }}">{{ overlay_text | escape }}</span>
          {% endif %}
        {% endcapture %}

        {% if link %}
          <a href="{{ link }}" class="three-image-row__link">
            {{ media_content | strip }}
          </a>
        {% else %}
          {{ media_content | strip }}
        {% endif %}
      {% else %}
        <div class="three-image-row__placeholder">
          {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
        </div>
        {% if overlay_text != blank %}
          <span class="three-image-row__text three-image-row__text--{{ text_position }}">{{ overlay_text | escape }}</span>
        {% endif %}
      {% endif %}
    </div>
  {% endfor %}
</div>

{% stylesheet %}
  .three-image-row {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 1px;
  }

  .three-image-row--full-width {
    width: 100vw;
    margin-left: calc(50% - 50vw);
    margin-right: calc(50% - 50vw);
  }

  .three-image-row__item {
    position: relative;
    overflow: hidden;
    background: rgb(var(--color-background));
  }

  .three-image-row--fixed-height .three-image-row__item {
    height: var(--three-image-row-height);
  }

  .three-image-row--has-ratio .three-image-row__item {
    aspect-ratio: var(--three-image-row-aspect);
  }

  .three-image-row__link,
  .three-image-row__link:visited {
    display: block;
    color: inherit;
  }

  .three-image-row__text {
    position: absolute;
    padding: 1rem 1.25rem;
    color: rgb(var(--color-foreground));
    background: rgba(var(--color-background), 0.7);
    border-radius: 0.4rem;
    pointer-events: none;
    text-align: center;
    max-width: calc(100% - 2rem);
    word-break: break-word;
  }

  .three-image-row__text--top-left {
    top: 0.75rem;
    left: 0.75rem;
  }

  .three-image-row__text--top-center {
    top: 0.75rem;
    left: 50%;
    transform: translateX(-50%);
  }

  .three-image-row__text--top-right {
    top: 0.75rem;
    right: 0.75rem;
  }

  .three-image-row__text--middle-left {
    top: 50%;
    left: 0.75rem;
    transform: translateY(-50%);
  }

  .three-image-row__text--center {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .three-image-row__text--middle-right {
    top: 50%;
    right: 0.75rem;
    transform: translateY(-50%);
  }

  .three-image-row__text--bottom-left {
    bottom: 0.75rem;
    left: 0.75rem;
  }

  .three-image-row__text--bottom-center {
    bottom: 0.75rem;
    left: 50%;
    transform: translateX(-50%);
  }

  .three-image-row__text--bottom-right {
    bottom: 0.75rem;
    right: 0.75rem;
  }

  .three-image-row__image {
    width: 100%;
    display: block;
    object-fit: cover;
    object-position: center;
  }

  .three-image-row--has-ratio .three-image-row__image {
    height: 100%;
  }

  .three-image-row--fixed-height .three-image-row__image {
    height: 100%;
  }

  .three-image-row__placeholder {
    position: relative;
    padding-top: 66.66%;
    background: rgba(var(--color-foreground), 0.04);
  }

  .three-image-row--has-ratio .three-image-row__placeholder {
    padding-top: 0;
    height: 100%;
  }

  .three-image-row--fixed-height .three-image-row__placeholder {
    padding-top: 0;
    height: 100%;
  }

  .three-image-row__placeholder .placeholder-svg {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Three image row",
  "tag": null,
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "label": "Image ratio",
      "default": "square",
      "options": [
        {
          "value": "adapt",
          "label": "Match image"
        },
        {
          "value": "square",
          "label": "Square"
        },
        {
          "value": "landscape",
          "label": "Landscape"
        },
        {
          "value": "portrait",
          "label": "Portrait"
        },
        {
          "value": "widescreen",
          "label": "Widescreen"
        }
      ]
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": false
    },
    {
      "type": "select",
      "id": "height",
      "label": "Height",
      "options": [
        {
          "value": "auto",
          "label": "Auto"
        },
        {
          "value": "custom",
          "label": "Custom"
        }
      ],
      "default": "auto"
    },
    {
      "type": "range",
      "id": "custom_height",
      "label": "Custom height",
      "min": 200,
      "max": 1200,
      "step": 10,
      "unit": "px",
      "default": 400,
      "visible_if": "{{ block.settings.height == 'custom' }}"
    },
    {
      "type": "header",
      "content": "First image"
    },
    {
      "type": "image_picker",
      "id": "image_1",
      "label": "Image"
    },
    {
      "type": "text",
      "id": "image_1_alt",
      "label": "Alt text",
      "info": "Alternative text for accessibility."
    },
    {
      "type": "text",
      "id": "text_1",
      "label": "Overlay text"
    },
    {
      "type": "select",
      "id": "text_position_1",
      "label": "Text position",
      "default": "center",
      "options": [
        {
          "value": "top-left",
          "label": "Top left"
        },
        {
          "value": "top-center",
          "label": "Top center"
        },
        {
          "value": "top-right",
          "label": "Top right"
        },
        {
          "value": "middle-left",
          "label": "Middle left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "middle-right",
          "label": "Middle right"
        },
        {
          "value": "bottom-left",
          "label": "Bottom left"
        },
        {
          "value": "bottom-center",
          "label": "Bottom center"
        },
        {
          "value": "bottom-right",
          "label": "Bottom right"
        }
      ]
    },
    {
      "type": "url",
      "id": "link_1",
      "label": "Link"
    },
    {
      "type": "header",
      "content": "Second image"
    },
    {
      "type": "image_picker",
      "id": "image_2",
      "label": "Image"
    },
    {
      "type": "text",
      "id": "image_2_alt",
      "label": "Alt text",
      "info": "Alternative text for accessibility."
    },
    {
      "type": "text",
      "id": "text_2",
      "label": "Overlay text"
    },
    {
      "type": "select",
      "id": "text_position_2",
      "label": "Text position",
      "default": "center",
      "options": [
        {
          "value": "top-left",
          "label": "Top left"
        },
        {
          "value": "top-center",
          "label": "Top center"
        },
        {
          "value": "top-right",
          "label": "Top right"
        },
        {
          "value": "middle-left",
          "label": "Middle left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "middle-right",
          "label": "Middle right"
        },
        {
          "value": "bottom-left",
          "label": "Bottom left"
        },
        {
          "value": "bottom-center",
          "label": "Bottom center"
        },
        {
          "value": "bottom-right",
          "label": "Bottom right"
        }
      ]
    },
    {
      "type": "url",
      "id": "link_2",
      "label": "Link"
    },
    {
      "type": "header",
      "content": "Third image"
    },
    {
      "type": "image_picker",
      "id": "image_3",
      "label": "Image"
    },
    {
      "type": "text",
      "id": "image_3_alt",
      "label": "Alt text",
      "info": "Alternative text for accessibility."
    },
    {
      "type": "text",
      "id": "text_3",
      "label": "Overlay text"
    },
    {
      "type": "select",
      "id": "text_position_3",
      "label": "Text position",
      "default": "center",
      "options": [
        {
          "value": "top-left",
          "label": "Top left"
        },
        {
          "value": "top-center",
          "label": "Top center"
        },
        {
          "value": "top-right",
          "label": "Top right"
        },
        {
          "value": "middle-left",
          "label": "Middle left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "middle-right",
          "label": "Middle right"
        },
        {
          "value": "bottom-left",
          "label": "Bottom left"
        },
        {
          "value": "bottom-center",
          "label": "Bottom center"
        },
        {
          "value": "bottom-right",
          "label": "Bottom right"
        }
      ]
    },
    {
      "type": "url",
      "id": "link_3",
      "label": "Link"
    }
  ],
  "presets": [
    {
      "name": "Three image row"
    }
  ]
}
{% endschema %}
